<div class="simple-container">
    <div class="simple-header">
        <button (click)="goBack()" class="simple-back-btn">
            ‚Üê Quay l·∫°i
        </button>
        <div class="header-content">
            <h1>Qu·∫£n l√Ω Gi√° Theo Khu V·ª±c</h1>
            <p>Xem v√† qu·∫£n l√Ω gi√° m√≥n ƒÉn theo t·ª´ng khu v·ª±c</p>
        </div>
        @if (selectedAreaFilter()) {
        <button (click)="openAddModal(selectedAreaFilter())" class="simple-add-btn">
            + Th√™m m√≥n v√†o {{ getSelectedAreaName() }}
        </button>
        } @else {
        <div style="color: #666; font-size: 14px; font-style: italic;">
            Ch·ªçn khu v·ª±c ƒë·ªÉ th√™m m√≥n
        </div>
        }
    </div>

    <!-- Search and Filter Section -->
    <div class="search-section">
        <div class="search-box">
            <input type="text" [(ngModel)]="searchText" (input)="onSearch()" placeholder="T√¨m ki·∫øm..."
                class="search-input">
            @if (searchText()) {
            <button (click)="clearSearch()" class="clear-btn">
                ‚úï
            </button>
            }
        </div>
        <div class="filter-box">
            <select [ngModel]="selectedAreaFilter()" (ngModelChange)="onAreaFilterChange($event)" class="filter-select">
                <option value="">T·∫•t c·∫£ khu v·ª±c</option>
                <option *ngFor="let area of areas()" [value]="area.areaId">
                    {{ area.areaName }}
                </option>
            </select>
            <input type="text" [ngModel]="dishNameFilter()" (ngModelChange)="onDishNameFilterChange($event)"
                placeholder="T√™n m√≥n ƒÉn..." class="filter-input">
            <input type="text" [ngModel]="kitchenNameFilter()" (ngModelChange)="onKitchenNameFilterChange($event)"
                placeholder="T√™n b·∫øp..." class="filter-input">
            <input type="text" [ngModel]="groupNameFilter()" (ngModelChange)="onGroupNameFilterChange($event)"
                placeholder="Nh√≥m m√≥n..." class="filter-input">
            <select [ngModel]="selectedStatus()" (ngModelChange)="onStatusFilterChange($event)" class="filter-select">
                <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
                <option value="true">Ho·∫°t ƒë·ªông</option>
                <option value="false">Kh√¥ng ho·∫°t ƒë·ªông</option>
            </select>
        </div>
    </div>

    <!-- Main Content -->
    <div class="simple-content">
        <!-- Loading State -->
        @if (loadingDishes()) {
        <div class="simple-loading">
            <div class="simple-spinner"></div>
            <p>ƒêang t·∫£i danh s√°ch gi√° m√≥n ƒÉn...</p>
        </div>
        }

        <!-- Error State -->
        @if (dishError()) {
        <div class="simple-error">
            {{ dishError() }}
        </div>
        }

        <!-- Area Dish Prices Table -->
        @if (dishPrices().length > 0 && !loadingDishes()) {
        <div class="dishes-table">
            <!-- Table Header -->
            <div class="table-header">
                <div class="col-id">#</div>
                <div class="col-code">M√£</div>
                <div class="col-area sortable" (click)="onSortColumn('areaName')">
                    Khu v·ª±c <span class="sort-icon">{{ getSortIcon('areaName') }}</span>
                </div>
                <div class="col-name sortable" (click)="onSortColumn('dishName')">
                    T√™n m√≥n ƒÉn <span class="sort-icon">{{ getSortIcon('dishName') }}</span>
                </div>
                <div class="col-name sortable" (click)="onSortColumn('basePrice')">
                    Gi√° G·ªëc <span class="sort-icon">{{ getSortIcon('basePrice') }}</span>
                </div>
                <div class="col-price sortable" (click)="onSortColumn('price')">
                    Gi√° khu v·ª±c <span class="sort-icon">{{ getSortIcon('price') }}</span>
                </div>
                <div class="col-date">Ng√†y hi·ªáu l·ª±c</div>
                <div class="col-status">Tr·∫°ng th√°i</div>
                <div class="col-actions">Thao t√°c</div>
            </div>

            <!-- Table Body -->
            @for (dishPrice of filteredDishPrices(); track dishPrice.id; let i = $index) {
            <div class="table-row">
                <div class="col-id">{{ (pageIndex() - 1) * selectedPageSize() + i + 1 }}</div>
                <div class="col-code">ADP{{ dishPrice.id.slice(-3) }}</div>
                <div class="col-area">{{ dishPrice.areaName || 'N/A' }}</div>
                <div class="col-name">{{ dishPrice.dishName || 'N/A' }}</div>
                <div class="col-price">
                    {{ (dishPrice.basePrice || 0) | currency:'VND':'symbol':'1.0-0' }}
                </div>
                <div class="col-price">{{ dishPrice.customPrice | currency:'VND':'symbol':'1.0-0' }}</div>
                <div class="col-date">{{ dishPrice.effectiveDate | date:'dd/MM/yyyy' }}</div>
                <div class="col-status">
                    <span class="status-badge" [class]="dishPrice.isActive ? 'active' : 'inactive'">
                        {{ dishPrice.isActive ? 'Ho·∫°t ƒë·ªông' : 'T·∫°m d·ª´ng' }}
                    </span>
                </div>
                <div class="col-actions">
                    <button class="action-btn edit-btn" (click)="openEditModal(dishPrice)" title="S·ª≠a gi√°">
                        ‚úèÔ∏è
                    </button>
                    <button class="action-btn quantity-btn"
                        (click)="openQuantityModal(dishPrice, 'e6847093-5ccb-417e-b49f-67630cc26386')"
                        title="ƒê·ªïi s·ªë l∆∞·ª£ng">
                        üìä
                    </button>
                    <button class="action-btn delete-btn" (click)="openRemoveModal(dishPrice)" title="X√≥a kh·ªèi khu v·ª±c">
                        üóëÔ∏è
                    </button>
                </div>
            </div>
            }
        </div>

        <!-- Pagination - Always show if there are any items -->
        @if (totalRecords() > 0) {
        <div class="pagination-container">
            <!-- Debug Info -->


            <!-- Page Size Selector -->
            <div class="page-size-selector">
                <label for="pageSizeDropdown">Hi·ªÉn th·ªã:</label>
                <select id="pageSizeDropdown" [ngModel]="selectedPageSize()" (ngModelChange)="onPageSizeChange($event)"
                    class="page-size-dropdown">
                    <option *ngFor="let size of dropdownValues" [value]="size">
                        {{ size }}
                    </option>
                </select>
                <span>d√≤ng</span>
                <span style="font-weight: 200;">T·ªïng s·ªë d√≤ng {{ totalRecords() }}</span>
            </div>

            <!-- Pagination Controls -->
            @if (totalPages() > 1) {
            <div class="pagination">
                <button class="page-btn" (click)="getAllAreaDishPrices(pageIndex() - 1)" [disabled]="pageIndex() <= 1">
                    ‚Äπ Tr∆∞·ªõc
                </button>

                @for (page of getPageNumbers(); track page) {
                <button class="page-btn" [class.active]="pageIndex() === page" (click)="getAllAreaDishPrices(page)"
                    [disabled]="pageIndex() === page">
                    {{ page }}
                </button>
                }

                <button class="page-btn" (click)="getAllAreaDishPrices(pageIndex() + 1)"
                    [disabled]="pageIndex() >= totalPages()">
                    Sau ‚Ä∫
                </button>
            </div>
            } @else {

            }
        </div>
        }
        }

        <!-- Empty State -->
        @if (filteredDishPrices().length === 0 && !loadingDishes() && !dishError()) {
        <div class="simple-empty">
            @if (searchText() || selectedAreaFilter() || selectedStatus() || dishNameFilter() || kitchenNameFilter() ||
            groupNameFilter()) {
            <h3>Kh√¥ng t√¨m th·∫•y gi√° m√≥n ƒÉn n√†o</h3>
            <p>Th·ª≠ thay ƒë·ªïi t·ª´ kh√≥a t√¨m ki·∫øm ho·∫∑c b·ªô l·ªçc</p>
            <button (click)="clearAllFilters()" class="simple-add-btn">
                X√≥a b·ªô l·ªçc
            </button>
            } @else {
            <h3>Ch∆∞a c√≥ gi√° m√≥n ƒÉn n√†o</h3>
            <p>Ch∆∞a c√≥ d·ªØ li·ªáu gi√° m√≥n ƒÉn theo khu v·ª±c</p>
            }
        </div>
        }
    </div>

    <!-- Edit Price Modal -->
    @if (showEditModal()) {
    <div class="simple-modal-overlay" (click)="closeEditModal()">
        <div class="simple-modal" (click)="$event.stopPropagation()">
            <h3>Ch·ªânh s·ª≠a gi√°</h3>

            @if (editingDish()) {
            <div class="modal-info">
                <p class="dish-name">{{ editingDish()?.dishName }}</p>
                <p class="area-name">{{ selectedArea()?.areaName }}</p>
                @if (editingDish()?.basePrice) {
                <p class="base-price">Gi√° g·ªëc: {{ editingDish()?.basePrice | currency:'VND':'symbol':'1.0-0' }}</p>
                }
            </div>
            }

            <form (ngSubmit)="updatePrice()">
                <div class="form-group">
                    <label>Gi√° m·ªõi (VND)</label>
                    <input type="number" [(ngModel)]="newPrice" name="newPrice" placeholder="0" min="0" required>
                </div>

                <div class="modal-actions">
                    <button type="button" (click)="closeEditModal()" class="simple-btn cancel-btn"
                        [disabled]="updatingPrice()">
                        H·ªßy
                    </button>
                    <button type="submit" class="simple-btn submit-btn"
                        [disabled]="updatingPrice() || !newPrice() || newPrice() < 0">
                        {{ updatingPrice() ? 'ƒêang l∆∞u...' : 'L∆∞u' }}
                    </button>
                </div>
            </form>
        </div>
    </div>
    }

    <!-- Quantity Modal -->
    @if (showQuantityModal()) {
    <div class="simple-modal-overlay" (click)="closeQuantityModal()">
        <div class="simple-modal" (click)="$event.stopPropagation()">
            <h3>Thay ƒë·ªïi s·ªë l∆∞·ª£ng</h3>

            @if (editingQuantity()) {
            <div class="modal-info">
                <p class="dish-name">{{ editingQuantity()?.dishName }}</p>
                <p class="order-id">Order ID: {{ currentOrderId() }}</p>
            </div>
            }

            <form (ngSubmit)="changeQuantity()">
                <div class="form-group">
                    <label>S·ªë l∆∞·ª£ng m·ªõi</label>
                    <input type="number" [(ngModel)]="newQuantity" name="newQuantity" placeholder="1" min="1" max="999"
                        required>
                </div>

                <div class="modal-actions">
                    <button type="button" (click)="closeQuantityModal()" class="simple-btn cancel-btn"
                        [disabled]="updatingQuantity()">
                        H·ªßy
                    </button>
                    <button type="submit" class="simple-btn submit-btn"
                        [disabled]="updatingQuantity() || !newQuantity() || newQuantity() < 1">
                        {{ updatingQuantity() ? 'ƒêang c·∫≠p nh·∫≠t...' : 'C·∫≠p nh·∫≠t' }}
                    </button>
                </div>
            </form>
        </div>
    </div>
    }

    <!-- Remove Area Dish Price Modal -->
    @if (showRemoveModal()) {
    <div class="simple-modal-overlay" (click)="closeRemoveModal()">
        <div class="simple-modal" (click)="$event.stopPropagation()">
            <h3>X√°c nh·∫≠n x√≥a m√≥n kh·ªèi khu v·ª±c</h3>

            @if (removingDish()) {
            <div class="modal-info">
                <p class="dish-name">{{ removingDish()?.dishName }}</p>
                <p class="area-name">Khu v·ª±c: {{ removingDish()?.areaName }}</p>
                <p class="warning">M√≥n ƒÉn s·∫Ω b·ªã x√≥a kh·ªèi khu v·ª±c n√†y!</p>
            </div>
            }

            <div class="modal-actions">
                <button (click)="closeRemoveModal()" class="simple-btn cancel-btn" [disabled]="removingFood()">
                    H·ªßy
                </button>
                <button (click)="removeAreaDishPrice()" class="simple-btn delete-btn" [disabled]="removingFood()">
                    {{ removingFood() ? 'ƒêang x√≥a...' : 'X√≥a kh·ªèi khu v·ª±c' }}
                </button>
            </div>
        </div>
    </div>
    }

    <!-- Add Dishes Modal -->
    @if (showAddModal()) {
    <div class="simple-modal-overlay" (click)="closeAddModal()">
        <div class="simple-modal add-modal" (click)="$event.stopPropagation()">
            <h3>Th√™m m√≥n v√†o khu v·ª±c</h3>

            @if (selectedArea()) {
            <div class="modal-info">
                <p class="area-name">Khu v·ª±c: {{ selectedArea()?.areaName }}</p>
            </div>
            }

            <form (ngSubmit)="addDishesToArea()">
                <!-- Available Dishes Section -->
                <div class="form-group">
                    <label>Ch·ªçn m√≥n ƒÉn:</label>

                    <!-- Search for available dishes -->
                    <div class="search-box" style="margin-bottom: 15px;">
                        <input type="text" [(ngModel)]="availableDishesSearchText"
                            (ngModelChange)="onAvailableDishesSearch()"
                            placeholder="T√¨m ki·∫øm m√≥n ƒÉn (t√™n, m√£, m√¥ t·∫£...)" class="search-input"
                            name="availableDishesSearch">
                        @if (availableDishesSearchText()) {
                        <button type="button" (click)="clearAvailableDishesSearch()" class="clear-btn">
                            ‚úï
                        </button>
                        }
                    </div>

                    @if (loadingAvailableDishes()) {
                    <div class="loading-dishes">
                        <div class="simple-spinner"></div>
                        <p>ƒêang t·∫£i danh s√°ch m√≥n ƒÉn...</p>
                    </div>
                    }

                    @if (availableDishes().length === 0 && !loadingAvailableDishes()) {
                    <div class="no-dishes">
                        @if (availableDishesSearchText()) {
                        <p>Kh√¥ng t√¨m th·∫•y m√≥n ƒÉn n√†o v·ªõi t·ª´ kh√≥a "{{ availableDishesSearchText() }}".</p>
                        <p>Th·ª≠ t√¨m ki·∫øm v·ªõi t·ª´ kh√≥a kh√°c ho·∫∑c <button type="button"
                                (click)="clearAvailableDishesSearch()"
                                style="background: none; border: none; color: #4a90e2; cursor: pointer; text-decoration: underline;">
                                x√≥a b·ªô l·ªçc</button>.</p>
                        } @else {
                        <p>Kh√¥ng c√≥ m√≥n ƒÉn n√†o c√≥ s·∫µn ƒë·ªÉ th√™m v√†o khu v·ª±c n√†y.</p>
                        }
                    </div>
                    }

                    @if (availableDishes().length > 0 && !loadingAvailableDishes()) {
                    <select [(ngModel)]="selectedDish" name="selectedDish" class="filter-select"
                        style="width: 100%; margin-bottom: 15px;">
                        <option value="">-- Ch·ªçn m√≥n ƒÉn --</option>
                        @for (dish of availableDishes(); track dish.dishId) {
                        <option [value]="dish.dishId">
                            {{ dish.dishName }} - {{ dish.basePrice | currency:'VND':'symbol':'1.0-0' }}
                            @if (dish.kitchenName) {
                            ({{ dish.kitchenName }})
                            }
                        </option>
                        }
                    </select>

                    <!-- Show selected dish details -->
                    @if (selectedDish()) {
                    <div class="selected-dish-info">
                        @for (dish of availableDishes(); track dish.dishId) {
                        @if (dish.dishId === selectedDish()) {
                        <div class="dish-details">
                            <h4>{{ dish.dishName }}</h4>
                            <p><strong>Gi√° g·ªëc:</strong> {{ dish.basePrice | currency:'VND':'symbol':'1.0-0' }}</p>
                            @if (dish.description) {
                            <p><strong>M√¥ t·∫£:</strong> {{ dish.description }}</p>
                            }
                            @if (dish.kitchenName) {
                            <p><strong>B·∫øp:</strong> {{ dish.kitchenName }}</p>
                            }
                            @if (dish.groupName) {
                            <p><strong>Nh√≥m:</strong> {{ dish.groupName }}</p>
                            }
                        </div>
                        }
                        }
                    </div>
                    }
                    }
                </div> <!-- Custom Price Section -->
                <div class="form-group">
                    <label>Gi√° cho khu v·ª±c n√†y (VND) *</label>
                    <input type="number" [(ngModel)]="customPrice" name="customPrice" placeholder="0" min="0" required>
                    <small class="price-note">Gi√° n√†y s·∫Ω √°p d·ª•ng cho m√≥n ƒÉn ƒë∆∞·ª£c ch·ªçn</small>
                </div>

                <!-- Selected Count -->
                @if (selectedDish()) {
                <div class="selected-count">
                    <p>ƒê√£ ch·ªçn m√≥n ƒÉn: {{ getSelectedDishName() }}</p>
                </div>
                }

                <div class="modal-actions">
                    <button type="button" (click)="closeAddModal()" class="simple-btn cancel-btn"
                        [disabled]="addingDishes()">
                        H·ªßy
                    </button>
                    <button type="submit" class="simple-btn submit-btn"
                        [disabled]="addingDishes() || !selectedDish() || !customPrice() || customPrice() <= 0">
                        {{ addingDishes() ? 'ƒêang th√™m...' : 'Th√™m m√≥n' }}
                    </button>
                </div>
            </form>
        </div>
    </div>
    }
</div>