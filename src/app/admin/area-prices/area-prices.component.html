<div class="simple-container">
    <div class="simple-header">
        <button (click)="goBack()" class="simple-back-btn">
            ‚Üê Quay l·∫°i
        </button>
        <div class="header-content">
            <h1>Qu·∫£n l√Ω Gi√° Theo Khu V·ª±c</h1>
            <p>Xem v√† qu·∫£n l√Ω gi√° m√≥n ƒÉn theo t·ª´ng khu v·ª±c</p>
        </div>
        @if (selectedAreaFilter()) {
        <button (click)="openAddModal(selectedAreaFilter())" class="simple-add-btn">
            + Th√™m m√≥n v√†o {{ getSelectedAreaName() }}
        </button>
        } @else {
        <div style="color: #666; font-size: 14px; font-style: italic;">
            Ch·ªçn khu v·ª±c ƒë·ªÉ th√™m m√≥n
        </div>
        }
    </div>

    <!-- Search and Filter Section -->
    <div class="search-section">
        <div class="search-box">
            <input type="text" [(ngModel)]="searchText" (input)="onSearch()" placeholder="T√¨m ki·∫øm..."
                class="search-input">
            @if (searchText()) {
            <button (click)="clearSearch()" class="clear-btn">
                ‚úï
            </button>
            }
        </div>
        <div class="filter-box">
            <select [(ngModel)]="selectedAreaFilter" (change)="onFilterChange()" class="filter-select">
                <option value="">T·∫•t c·∫£ khu v·ª±c</option>
                <option *ngFor="let area of areas()" [value]="area.areaId">
                    {{ area.areaName }}
                </option>
            </select>
            <input type="text" [(ngModel)]="dishNameFilter" (input)="onFilterChange()" placeholder="T√™n m√≥n ƒÉn..."
                class="filter-input">
            <input type="text" [(ngModel)]="kitchenNameFilter" (input)="onFilterChange()" placeholder="T√™n b·∫øp..."
                class="filter-input">
            <input type="text" [(ngModel)]="groupNameFilter" (input)="onFilterChange()" placeholder="Nh√≥m m√≥n..."
                class="filter-input">
            <select [(ngModel)]="selectedStatus" (change)="onFilterChange()" class="filter-select">
                <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
                <option value="true">Ho·∫°t ƒë·ªông</option>
                <option value="false">Kh√¥ng ho·∫°t ƒë·ªông</option>
            </select>
        </div>
    </div>

    <!-- Main Content -->
    <div class="simple-content">
        <!-- Loading State -->
        @if (loadingDishes()) {
        <div class="simple-loading">
            <div class="simple-spinner"></div>
            <p>ƒêang t·∫£i danh s√°ch gi√° m√≥n ƒÉn...</p>
        </div>
        }

        <!-- Error State -->
        @if (dishError()) {
        <div class="simple-error">
            {{ dishError() }}
        </div>
        }

        <!-- Area Dish Prices Table -->
        @if (dishPrices().length > 0 && !loadingDishes()) {
        <div class="dishes-table">
            <!-- Table Header -->
            <div class="table-header">
                <div class="col-id">#</div>
                <div class="col-code">M√£</div>
                <div class="col-area sortable" (click)="onSortColumn('areaName')">
                    Khu v·ª±c <span class="sort-icon">{{ getSortIcon('areaName') }}</span>
                </div>
                <div class="col-name sortable" (click)="onSortColumn('dishName')">
                    T√™n m√≥n ƒÉn <span class="sort-icon">{{ getSortIcon('dishName') }}</span>
                </div>
                <div class="col-name sortable" (click)="onSortColumn('dish')">
                    Gi√° G·ªëc <span class="sort-icon">{{ getSortIcon('dish') }}</span>
                </div>
                <div class="col-price sortable" (click)="onSortColumn('price')">
                    Gi√° khu v·ª±c <span class="sort-icon">{{ getSortIcon('price') }}</span>
                </div>
                <div class="col-date">Ng√†y hi·ªáu l·ª±c</div>
                <div class="col-status">Tr·∫°ng th√°i</div>
                <div class="col-actions">Thao t√°c</div>
            </div>

            <!-- Table Body -->
            @for (dishPrice of filteredDishPrices(); track dishPrice.id; let i = $index) {
            <div class="table-row">
                <div class="col-id">{{ (pageIndex() - 1) * selectedPageSize() + i + 1 }}</div>
                <div class="col-code">ADP{{ dishPrice.id.slice(-3) }}</div>
                <div class="col-area">{{ dishPrice.areaName || 'N/A' }}</div>
                <div class="col-name">{{ dishPrice.dishName || 'N/A' }}</div>
                <div class="col-price">
                    @if (dishPrice.basePrice) {
                    {{ dishPrice.basePrice | currency:'VND':'symbol':'1.0-0' }}
                    } @else {
                    <span style="color: #999;">N/A</span>
                    }
                </div>
                <div class="col-price">{{ dishPrice.customPrice | currency:'VND':'symbol':'1.0-0' }}</div>
                <div class="col-date">{{ dishPrice.effectiveDate | date:'dd/MM/yyyy' }}</div>
                <div class="col-status">
                    <span class="status-badge" [class]="dishPrice.isActive ? 'active' : 'inactive'">
                        {{ dishPrice.isActive ? 'Ho·∫°t ƒë·ªông' : 'T·∫°m d·ª´ng' }}
                    </span>
                </div>
                <div class="col-actions">
                    <button class="action-btn edit-btn" (click)="openEditModal(dishPrice)" title="S·ª≠a gi√°">
                        ‚úèÔ∏è
                    </button>
                    <button class="action-btn quantity-btn"
                        (click)="openQuantityModal(dishPrice, 'e6847093-5ccb-417e-b49f-67630cc26386')"
                        title="ƒê·ªïi s·ªë l∆∞·ª£ng">
                        üìä
                    </button>
                    <button class="action-btn delete-btn"
                        (click)="openRemoveModal(dishPrice, 'e6847093-5ccb-417e-b49f-67630cc26386')" title="X√≥a">
                        üóëÔ∏è
                    </button>
                </div>
            </div>
            }
        </div>

        <!-- Pagination -->
        @if (totalPages() > 1) {
        <div class="pagination-container">
            <!-- Page Size Selector -->
            <div class="page-size-selector">
                <label for="pageSizeDropdown">Hi·ªÉn th·ªã:</label>
                <select id="pageSizeDropdown" [ngModel]="selectedPageSize()" (ngModelChange)="onPageSizeChange($event)"
                    class="page-size-dropdown">
                    <option *ngFor="let size of dropdownValues" [value]="size">
                        {{ size }}
                    </option>
                </select>
                <span>m·ª•c/trang</span>
            </div>

            <!-- Pagination Controls -->
            <div class="pagination">
                <button class="page-btn" (click)="getAllAreaDishPrices(pageIndex() - 1)" [disabled]="pageIndex() <= 1">
                    ‚Äπ Tr∆∞·ªõc
                </button>

                @for (page of getPageNumbers(); track page) {
                <button class="page-btn" [class.active]="pageIndex() === page" (click)="getAllAreaDishPrices(page)"
                    [disabled]="pageIndex() === page">
                    {{ page }}
                </button>
                }

                <button class="page-btn" (click)="getAllAreaDishPrices(pageIndex() + 1)"
                    [disabled]="pageIndex() >= totalPages()">
                    Sau ‚Ä∫
                </button>
            </div>
        </div>
        }
        }

        <!-- Empty State -->
        @if (filteredDishPrices().length === 0 && !loadingDishes() && !dishError()) {
        <div class="simple-empty">
            @if (searchText() || selectedAreaFilter() || selectedStatus() || dishNameFilter() || kitchenNameFilter() ||
            groupNameFilter()) {
            <h3>Kh√¥ng t√¨m th·∫•y gi√° m√≥n ƒÉn n√†o</h3>
            <p>Th·ª≠ thay ƒë·ªïi t·ª´ kh√≥a t√¨m ki·∫øm ho·∫∑c b·ªô l·ªçc</p>
            <button (click)="clearAllFilters()" class="simple-add-btn">
                X√≥a b·ªô l·ªçc
            </button>
            } @else {
            <h3>Ch∆∞a c√≥ gi√° m√≥n ƒÉn n√†o</h3>
            <p>Ch∆∞a c√≥ d·ªØ li·ªáu gi√° m√≥n ƒÉn theo khu v·ª±c</p>
            }
        </div>
        }
    </div>

    <!-- Edit Price Modal -->
    @if (showEditModal()) {
    <div class="simple-modal-overlay" (click)="closeEditModal()">
        <div class="simple-modal" (click)="$event.stopPropagation()">
            <h3>Ch·ªânh s·ª≠a gi√°</h3>

            @if (editingDish()) {
            <div class="modal-info">
                <p class="dish-name">{{ editingDish()?.dishName }}</p>
                <p class="area-name">{{ selectedArea()?.areaName }}</p>
                @if (editingDish()?.basePrice) {
                <p class="base-price">Gi√° g·ªëc: {{ editingDish()?.basePrice | currency:'VND':'symbol':'1.0-0' }}</p>
                }
            </div>
            }

            <form (ngSubmit)="updatePrice()">
                <div class="form-group">
                    <label>Gi√° m·ªõi (VND)</label>
                    <input type="number" [(ngModel)]="newPrice" name="newPrice" placeholder="0" min="0" required>
                </div>

                <div class="modal-actions">
                    <button type="button" (click)="closeEditModal()" class="simple-btn cancel-btn"
                        [disabled]="updatingPrice()">
                        H·ªßy
                    </button>
                    <button type="submit" class="simple-btn submit-btn"
                        [disabled]="updatingPrice() || !newPrice() || newPrice() < 0">
                        {{ updatingPrice() ? 'ƒêang l∆∞u...' : 'L∆∞u' }}
                    </button>
                </div>
            </form>
        </div>
    </div>
    }

    <!-- Quantity Modal -->
    @if (showQuantityModal()) {
    <div class="simple-modal-overlay" (click)="closeQuantityModal()">
        <div class="simple-modal" (click)="$event.stopPropagation()">
            <h3>Thay ƒë·ªïi s·ªë l∆∞·ª£ng</h3>

            @if (editingQuantity()) {
            <div class="modal-info">
                <p class="dish-name">{{ editingQuantity()?.dishName }}</p>
                <p class="order-id">Order ID: {{ currentOrderId() }}</p>
            </div>
            }

            <form (ngSubmit)="changeQuantity()">
                <div class="form-group">
                    <label>S·ªë l∆∞·ª£ng m·ªõi</label>
                    <input type="number" [(ngModel)]="newQuantity" name="newQuantity" placeholder="1" min="1" max="999"
                        required>
                </div>

                <div class="modal-actions">
                    <button type="button" (click)="closeQuantityModal()" class="simple-btn cancel-btn"
                        [disabled]="updatingQuantity()">
                        H·ªßy
                    </button>
                    <button type="submit" class="simple-btn submit-btn"
                        [disabled]="updatingQuantity() || !newQuantity() || newQuantity() < 1">
                        {{ updatingQuantity() ? 'ƒêang c·∫≠p nh·∫≠t...' : 'C·∫≠p nh·∫≠t' }}
                    </button>
                </div>
            </form>
        </div>
    </div>
    }

    <!-- Remove Food Modal -->
    @if (showRemoveModal()) {
    <div class="simple-modal-overlay" (click)="closeRemoveModal()">
        <div class="simple-modal" (click)="$event.stopPropagation()">
            <h3>X√°c nh·∫≠n x√≥a m√≥n</h3>

            @if (removingDish()) {
            <div class="modal-info">
                <p class="dish-name">{{ removingDish()?.dishName }}</p>
                <p class="order-id">Order ID: {{ currentOrderId() }}</p>
                <p class="warning">M√≥n ƒÉn s·∫Ω b·ªã x√≥a ho√†n to√†n kh·ªèi order!</p>
            </div>
            }

            <div class="modal-actions">
                <button (click)="closeRemoveModal()" class="simple-btn cancel-btn" [disabled]="removingFood()">
                    H·ªßy
                </button>
                <button (click)="removeFood()" class="simple-btn delete-btn" [disabled]="removingFood()">
                    {{ removingFood() ? 'ƒêang x√≥a...' : 'X√≥a m√≥n' }}
                </button>
            </div>
        </div>
    </div>
    }

    <!-- Add Dishes Modal -->
    @if (showAddModal()) {
    <div class="simple-modal-overlay" (click)="closeAddModal()">
        <div class="simple-modal add-modal" (click)="$event.stopPropagation()">
            <h3>Th√™m m√≥n v√†o khu v·ª±c</h3>

            @if (selectedArea()) {
            <div class="modal-info">
                <p class="area-name">Khu v·ª±c: {{ selectedArea()?.areaName }}</p>
            </div>
            }

            <form (ngSubmit)="addDishesToArea()">
                <!-- Available Dishes Section -->
                <div class="form-group">
                    <label>Ch·ªçn m√≥n ƒÉn:</label>

                    <!-- Search for available dishes -->
                    <div class="search-box" style="margin-bottom: 10px;">
                        <input type="text" [(ngModel)]="availableDishesSearchText" (input)="onAvailableDishesSearch()"
                            placeholder="T√¨m m√≥n ƒÉn..." class="search-input" name="availableDishesSearch">
                        @if (availableDishesSearchText()) {
                        <button type="button" (click)="clearAvailableDishesSearch()" class="clear-btn">
                            ‚úï
                        </button>
                        }
                    </div>

                    @if (loadingAvailableDishes()) {
                    <div class="loading-dishes">
                        <div class="simple-spinner"></div>
                        <p>ƒêang t·∫£i danh s√°ch m√≥n ƒÉn...</p>
                    </div>
                    }

                    @if (availableDishes().length === 0 && !loadingAvailableDishes()) {
                    <div class="no-dishes">
                        <p>Kh√¥ng c√≥ m√≥n ƒÉn n√†o c√≥ s·∫µn ƒë·ªÉ th√™m v√†o khu v·ª±c n√†y.</p>
                    </div>
                    }

                    @if (availableDishes().length > 0 && !loadingAvailableDishes()) {
                    <div class="dishes-selection">
                        @for (dish of availableDishes(); track dish.dishId) {
                        <div class="dish-item">
                            <input type="checkbox" [id]="'dish-' + dish.dishId"
                                [checked]="selectedDishes().includes(dish.dishId)"
                                (change)="toggleDishSelection(dish.dishId)">
                            <label [for]="'dish-' + dish.dishId" class="dish-label">
                                <div class="dish-info">
                                    <span class="dish-name">{{ dish.dishName }}</span>
                                    <span class="dish-price">{{ dish.basePrice | currency:'VND':'symbol':'1.0-0'
                                        }}</span>
                                </div>
                                @if (dish.description) {
                                <div class="dish-description">{{ dish.description }}</div>
                                }
                                @if (dish.kitchenName || dish.groupName) {
                                <div class="dish-meta">
                                    @if (dish.kitchenName) {
                                    <span class="kitchen-name">B·∫øp: {{ dish.kitchenName }}</span>
                                    }
                                    @if (dish.groupName) {
                                    <span class="group-name">Nh√≥m: {{ dish.groupName }}</span>
                                    }
                                </div>
                                }
                            </label>
                        </div>
                        }
                    </div>

                    <!-- Pagination for available dishes -->
                    @if (availableDishesTotalPages() > 1) {
                    <div class="dishes-pagination">
                        <div class="pagination">
                            <button type="button" class="page-btn"
                                (click)="loadAvailableDishes(selectedArea()!.areaId, availableDishesPageIndex() - 1)"
                                [disabled]="availableDishesPageIndex() <= 1">
                                ‚Äπ Tr∆∞·ªõc
                            </button>

                            @for (page of getAvailableDishesPageNumbers(); track page) {
                            <button type="button" class="page-btn" [class.active]="availableDishesPageIndex() === page"
                                (click)="loadAvailableDishes(selectedArea()!.areaId, page)"
                                [disabled]="availableDishesPageIndex() === page">
                                {{ page }}
                            </button>
                            }

                            <button type="button" class="page-btn"
                                (click)="loadAvailableDishes(selectedArea()!.areaId, availableDishesPageIndex() + 1)"
                                [disabled]="availableDishesPageIndex() >= availableDishesTotalPages()">
                                Sau ‚Ä∫
                            </button>
                        </div>
                        <div class="pagination-info">
                            Trang {{ availableDishesPageIndex() }} / {{ availableDishesTotalPages() }}
                        </div>
                    </div>
                    }
                    }
                </div> <!-- Custom Price Section -->
                <div class="form-group">
                    <label>Gi√° cho khu v·ª±c n√†y (VND) *</label>
                    <input type="number" [(ngModel)]="customPrice" name="customPrice" placeholder="0" min="0" required>
                    <small class="price-note">Gi√° n√†y s·∫Ω √°p d·ª•ng cho t·∫•t c·∫£ m√≥n ƒÉn ƒë∆∞·ª£c ch·ªçn</small>
                </div>

                <!-- Selected Count -->
                @if (selectedDishes().length > 0) {
                <div class="selected-count">
                    <p>ƒê√£ ch·ªçn {{ selectedDishes().length }} m√≥n ƒÉn</p>
                </div>
                }

                <div class="modal-actions">
                    <button type="button" (click)="closeAddModal()" class="simple-btn cancel-btn"
                        [disabled]="addingDishes()">
                        H·ªßy
                    </button>
                    <button type="submit" class="simple-btn submit-btn"
                        [disabled]="addingDishes() || selectedDishes().length === 0 || !customPrice() || customPrice() <= 0">
                        {{ addingDishes() ? 'ƒêang th√™m...' : 'Th√™m m√≥n' }}
                    </button>
                </div>
            </form>
        </div>
    </div>
    }
</div>